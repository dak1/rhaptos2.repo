// Generated by CoffeeScript 1.3.3

/*
  authoringtools_client_tools.{coffee,js} - The script used set up and control
    the extended tools interface. These are the tools that are found in the
    tools dropdown in the interface.

  Author: Michael Mulich
  Copyright (c) 2012 Rice University

  This software is subject to the provisions of the GNU Lesser General
  Public License Version 2.1 (LGPL).  See LICENSE.txt for details.
*/


(function() {
  var MetadataModal, ROLES, RoleCollection, RoleEntry, RolesModal, exports, _form_values_to_object, _generate_metadata_url,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  exports = {};

  _generate_metadata_url = function(id) {
    return MODULEURL + id + '/metadata';
  };

  _form_values_to_object = function(selector) {
    var data;
    data = {};
    $.map($(selector).serializeArray(), function(obj) {
      return data[obj['name']] = obj['value'];
    });
    return data;
  };

  MetadataModal = (function() {

    function MetadataModal() {
      this.submit_handler = __bind(this.submit_handler, this);
      this.$el = $('#metadata-modal');
      this.render();
    }

    MetadataModal.prototype.submit_handler = function(event) {
      var data, module_id;
      data = _form_values_to_object('#metadata-modal form');
      module_id = serialise_form().uuid;
      console.log('Posting metadata for module: ' + module_id);
      $.ajax({
        type: 'POST',
        url: _generate_metadata_url(module_id),
        data: JSON.stringify(data, null, 2),
        dataType: 'json',
        contentType: 'application/json',
        success: function() {
          return $('#metadata-modal').modal('hide');
        }
      });
      return false;
    };

    MetadataModal.prototype.language_handler = function() {
      var $variant_lang, code, selected_code, template, value, variants, _ref;
      selected_code = $(this).val();
      variants = [];
      _ref = Language.getCombined();
      for (code in _ref) {
        value = _ref[code];
        if (code.slice(0, 2) === selected_code) {
          $.extend(value, {
            code: code
          });
          variants.push(value);
        }
      }
      $variant_lang = $('#metadata-modal select[name="variant_language"]');
      if (variants.length > 0) {
        variants.splice(0, 0, {
          code: '',
          english: ''
        });
        template = '{{#variants}}<option value="{{code}}">{{english}}</option>{{/variants}}';
        return $variant_lang.removeAttr('disabled').html(Mustache.to_html(template, {
          'variants': variants
        }));
      } else {
        return $('#metadata-modal select[name="variant_language"]').html('').attr('disabled', 'disabled');
      }
    };

    MetadataModal.prototype.render = function() {
      var data, language_code, languages, value, _ref;
      data = {};
      languages = [
        {
          code: '',
          "native": '',
          english: ''
        }
      ];
      _ref = Language.getLanguages();
      for (language_code in _ref) {
        value = _ref[language_code];
        $.extend(value, {
          'code': language_code
        });
        languages.push(value);
      }
      $.extend(data, {
        'languages': languages
      });
      $('#metadata-modal .modal-body').html(Mustache.to_html(Templates.metadata, data));
      $('#metadata-modal select[name="language"]').change(this.language_handler);
      return $('#metadata-modal button[type="submit"]').click(this.submit_handler);
    };

    return MetadataModal;

  })();

  ROLES = ["Author", "Maintainer", "Copyright Holder"];

  RoleEntry = (function() {
    /*
        Data for a single role.
    */

    function RoleEntry(name, roles, collection) {
      this.name = name || "";
      this.roles = roles || [];
      this.collection = collection || null;
    }

    return RoleEntry;

  })();

  RoleCollection = (function() {
    /*
        A collection/container of RoleEntry objects.
    */

    function RoleCollection(entries) {
      var entry, _i, _len;
      this.entries = entries || [];
      for (_i = 0, _len = entries.length; _i < _len; _i++) {
        entry = entries[_i];
        entry.collection = this;
      }
    }

    RoleCollection.prototype.add = function(entry) {
      /*
            Adds an entry to this collection object.
      */

      var i;
      entry.collection = this;
      i = this.entries.push(entry);
      return this.entries[i - 1];
    };

    RoleCollection.prototype.remove = function(entry) {
      /*
            Removes the given entry from this collection object.
      */
      return this.entries.splice(this.entries.indexOf(entry), 1);
    };

    return RoleCollection;

  })();

  RolesModal = (function() {

    function RolesModal() {
      this.$el = $('#roles-modal');
      this.render();
    }

    RolesModal.prototype.render = function() {
      var $add_entry, entries, entry, _i, _len, _ref, _results;
      entries = [new RoleEntry('Michael', ['Maintainer', 'Copyright Holder']), new RoleEntry('Isabel', ['Author'])];
      this.collection = new RoleCollection(entries);
      $('#roles-modal .modal-body').html(Mustache.to_html(Templates.roles, {
        roles_vocabulary: ROLES
      }));
      entry = new RoleEntry();
      $add_entry = $(Mustache.to_html(Templates.roles_add_entry, this._prepare_entry_for_rendering(entry)));
      $('input[type="checkbox"]', $add_entry).click(this._role_selected_handler(entry));
      $('.role-add-action', $add_entry).click(this._role_add_handler(entry));
      $('#roles-modal tbody').append($add_entry);
      _ref = this.collection.entries;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        entry = _ref[_i];
        _results.push(this.render_entry(entry));
      }
      return _results;
    };

    RolesModal.prototype.render_entry = function(entry) {
      var $rendered_entry, data;
      data = this._prepare_entry_for_rendering(entry);
      $rendered_entry = $(Mustache.to_html(Templates.roles_name_entry, data));
      $('input[type="checkbox"]', $rendered_entry).click(this._role_selected_handler(entry));
      $('.role-removal-action', $rendered_entry).click(this._role_removal_handler(entry));
      return $('#roles-modal tbody tr:last').before($rendered_entry);
    };

    RolesModal.prototype._prepare_entry_for_rendering = function(entry) {
      /*
            Create a Mustache compatible RoleEntry representation.
      */

      var data, role, roles, value, _i, _len;
      data = $.extend({}, entry);
      roles = [];
      for (_i = 0, _len = ROLES.length; _i < _len; _i++) {
        role = ROLES[_i];
        value = {
          name: role
        };
        if (__indexOf.call(data.roles, role) >= 0) {
          value.selected = true;
        }
        roles.push(value);
      }
      $.extend(data, {
        roles: roles
      });
      return data;
    };

    RolesModal.prototype._role_add_handler = function(entry) {
      /*
            Create an event handler that will add a RoleEntry
            to the collection and render it.
      */

      var event_handler,
        _this = this;
      event_handler = function(event) {
        var $name_field, $row, name, _entry;
        $row = $(event.target).parents('tr');
        $name_field = $row.find('input[name="name"]');
        name = $name_field.val();
        _entry = _this.collection.add(new RoleEntry(name, entry.roles));
        console.log("Added '" + name + "' to the roles collection.");
        _this.render_entry(_entry);
        $name_field.val('');
        $row.find('input[type="checkbox"]').attr('checked', false);
        return entry.roles = [];
      };
      return event_handler;
    };

    RolesModal.prototype._role_selected_handler = function(entry) {
      /*
            Creates an event handler that will modify the given RoleEntry based
            on the selection.
      */

      var event_handler,
        _this = this;
      event_handler = function(event) {
        var $target, role_name;
        $target = $(event.target);
        role_name = $target.val();
        if ($target.is(':checked')) {
          entry.roles.push(role_name);
          return console.log("Gave the '" + role_name + "' role to '" + entry.name + "'.");
        } else {
          entry.roles.pop(entry.roles.indexOf(role_name));
          return console.log("Took the '" + role_name + "' role away from '" + entry.name + "'.");
        }
      };
      return event_handler;
    };

    RolesModal.prototype._role_removal_handler = function(entry) {
      /*
            Creates an event handler that will remove the given RoleEntry from the
            page and from the collection.
      */

      var event_handler,
        _this = this;
      event_handler = function(event) {
        $(event.target).parents('tr').remove();
        entry.collection.remove(entry);
        return console.log("Removed '" + entry.name + "' from the roles collection.");
      };
      return event_handler;
    };

    return RolesModal;

  })();

  exports.construct = function() {
    var metadata_modal, modal_link_id, roles_modal, _i, _len, _ref;
    $('.dropdown-toggle').dropdown();
    _ref = ['#import-link', '#metadata-link', '#roles-link', '#sharing-link', '#publish-link'];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      modal_link_id = _ref[_i];
      $(modal_link_id).modal({
        show: false
      });
    }
    $('#import-modal .modal-body').html(Mustache.to_html(Templates.metadata, {}));
    metadata_modal = new MetadataModal();
    roles_modal = new RolesModal();
    $('#sharing-modal .modal-body').html(Mustache.to_html(Templates.sharing, {}));
    return $('#publish-modal .modal-body').html(Mustache.to_html(Templates.publish, {}));
  };

  window.Tools = exports;

}).call(this);
