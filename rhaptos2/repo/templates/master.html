{% set cdnaloha = "/cdn/aloha" %}
{% set cdnjs = "/cdn/js" %}
{% set cdncss = "/cdn/css" %}
<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  {% block head %}
    <meta charset="utf-8">
    <!--[if IE]>
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <![endif]-->
    <title>{% block page_title %}{% endblock %}</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">

    {% block css %}
    <link rel="stylesheet" href="static/css/bootstrap.css">
    <link rel="stylesheet" href="{{ cdnaloha }}/src/css/jquery-ui/jquery.ui.all.css"
          type="text/css">    
    <link rel="stylesheet" href="{{ cdnaloha }}/src/css/aloha.css"
          type="text/css">
    <link rel="stylesheet" href="/static/css/custom.css"
          type="text/css">
    {% endblock %}{# css block #}

    {% block _js %}
    {# Global Javascript that shouldn't be overridden. #}
    <script src="https://login.persona.org/include.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.js"></script>
    {% endblock %}

    {% block js %}
    <script src="{{ cdnaloha }}/src/lib/require.js"></script> 
    <script>define('jquery', [], function () { return window.jQuery; });</script>
  <script src="{{ cdnaloha }}/src/plugins/extra/math/lib/MathJax.js?config=TeX-MML-AM_HTMLorMML-full&amp;delayStartupUntil=configured"></script>


  <!-- ============================= -->
  <!--  Configure MathJax and Aloha  -->
  <!-- ============================= -->
  <script type="text/x-mathjax-config">MathJax.Hub.Config({
    jax: ["input/MathML", "input/TeX", "input/AsciiMath", "output/NativeMML", "output/HTML-CSS"],
    extensions: ["asciimath2jax.js", "tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js"],
    tex2jax: { inlineMath: [["[TEX_START]","[TEX_END]"], ["\\(", "\\)"]] },
    // Apparently we can't change the escape sequence for ASCIIMath (MathJax doesn't find it)
    // asciimath2jax: { inlineMath: [["[ASCIIMATH_START]", "[ASCIIMATH_END]"]], },

    // The default for Firefox is "HTML" for some reason so change it to MML
    MMLorHTML: {prefer:{MSIE:"MML",Firefox:"MML",Opera:"HTML",Chrome:"HTML",Safari:"HTML",other:"HTML"}},
    TeX: {
      extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"], noErrors: { disabled: true }
    },
    AsciiMath: { noErrors: { disabled: true } }
        });
  </script>
	<script type="text/javascript">
		Aloha = window.Aloha || {};

		Aloha.settings = {
			jQuery: window.jQuery,
			logLevels: {'error': true, 'warn': true, 'info': false, 'debug': false},
			errorhandling : true,

			plugins: {
			  // This whole thing is what's needed to:
			  // - set a custom URL to send files to
			  // - register a callback that updates the IMG with the new src
			  draganddropfiles: {
          upload: {
            config: {
              method: 'POST',
              url: '/resources',
              fieldName: 'data',
              send_multipart_form: true,
              callback: function(resp) {
                //TODO: add xhr to Aloha.trigger('aloha-upload-*') in dropfilesrepository.js
                // dropfilesrepository.js triggers 'aloha-upload-success'
                // and 'aloha-upload-failure' but does not provide the
                // response text (URL).
                // We should probably change dropfilesrepository.js to be
                //  Aloha.trigger('aloha-upload-success', that, xhr);

                // Then, instead of configuring a callback we could just listen to that event

                // If the response is a URL then change the Image source to it
                // The URL could be absolute (/^http/) or relative (/\// or [a-z])
                if (resp.match(/^http/) || resp.match(/^\//) || resp.match(/^[a-z]/) ) {
                } else {
                  alert('You dropped a file and we sent a message to the server to do something with it.\nIt responded with some gibberish so we are showing you some other file to show it worked');
                  resp = "src/test/AlohaEditorLogo.png";
                }

                Aloha.jQuery('#' + this.id).attr('src', resp);
                console.log('Updated Image src as a result of upload');
              }
            }
          }
			  },
				block: {
					defaults : {
						'.default-block': {
						},
						'figure': {
							'aloha-block-type': 'EditableImageBlock'
						},
					}
				}
			},
			bundles: {
				// Path for custom bundle relative from require.js path
				user: '../demo/block'
			}
		};

	</script>
    <script src="{{ cdnaloha }}/src/lib/aloha.js" data-aloha-plugins="
                          extra/toolbar,
                          common/ui,
                          common/format,
                          common/paste,
                          common/block,
                          common/list,
                          common/table,
                          extra/draganddropfiles,
                          common/image,
                          oerpub/popover,
                          oerpub/math,
                          oerpub/assorted,
                          oerpub/image"></script>


    <script src="http://{{confd['rhaptos2repo']['www_server_name']}}/static/js/lib/bootstrap.js"
            type="text/javascript"></script>
    <script src="http://{{confd['rhaptos2repo']['www_server_name']}}/static/js/lib/mustache.js"
            type="text/javascript"></script>
    <script src="http://{{confd['rhaptos2repo']['www_server_name']}}/static/js/lib/spin.js"
            type="text/javascript"></script>
    <script src="/static/js/languagelib.js" 
            type="text/javascript"></script>

    <script src="http://{{ confd['rhaptos2repo']['www_server_name'] }}/conf.js"
            type="text/javascript"></script>
    <script src="http://{{ confd['rhaptos2repo']['www_server_name'] }}/static/authortools_client_templates.js"
            type="text/javascript"></script>
    <script src="http://{{ confd['rhaptos2repo']['www_server_name'] }}/static/authortools_client_tools.js"
            type="text/javascript"></script>
    <script src="http://{{ confd['rhaptos2repo']['www_server_name'] }}/static/authortools_client.js"
            type="text/javascript"></script>

    <script type="text/javascript">
      /* To be simple means to get current logged in USer back to JQuery*/
      var whoami = {
          userID      : "{{ g.user.userID }}",
          {% if g.user == None %}authenticated_identifier: null,{% else %}authenticated_identifier: "{{ g.user.authenticated_identifier }}", {% endif %}
          email       : "{{ g.user.email }}",
          name        : "{{ g.user.name }}"
      }
    </script>
    {% endblock %}{# js block #}
  {% endblock %}

<!-- =============== -->
<!-- Aloha Startup -->
<!-- =============== -->
  <script type="text/javascript">
    Aloha.ready( function() {
      Aloha.jQuery('.document').aloha().focus();
      // Wait until Aloha is started before loading MathJax
      // Also, wrap all math in a span/div. MathJax replaces the MathJax element
      // losing all jQuery data attached to it (like popover data, the original Math Formula, etc)
      // add aloha-cleanme so this span is unwrapped
      jQuery('math').wrap('<span class="math-element aloha-cleanme"></span>')
      MathJax.Hub.Configured();
      //$('*[rel=tooltip]').tooltip();
    });
  </script>
</head>
<body>
    <!--[if lt IE 7]>
        <p class="chromeframe">You are using an outdated
          browser. <a href="http://browsehappy.com/">Upgrade your browser today</a>
          or <a href="http://www.google.com/chromeframe/?redirect=true">install
          Google Chrome Frame</a> to better experience this site.
        </p>
    <![endif]-->
  {% block body %}

    {# Start page navigation controls #}
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
	  <ul class="nav">
	    <li class="active">
	      <a class="brand" href="#">ConneXions</a>
	    </li>
	    <li><a href="#">About</a></li>
	    <li><a href="#">MyCNX</a></li>

            <li class="dropdown">
              <a href="#"
                 class="dropdown-toggle"
                 data-toggle="dropdown">
                Tools
                <b class="caret"></b>
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a tabindex="-1" href="#import-modal"
                     id="import-link"
                     data-toggle="modal">Import</a>
                </li>
                <li><a tabindex="-1" href="#">Preview ...</a></li>
                <li>
                  <a tabindex="-1" href="#publish-modal"
                     id="publish-link"
                     data-toggle="modal">Publish</a>
                </li>
                <li>
                  <a tabindex="-1" href="#roles-modal"
                     id="roles-link"
                     data-toggle="modal">Roles Management</a>
                </li>
                <li>
                  <a tabindex="-1" href="#sharing-modal"
                     id="sharing-link"
                     data-toggle="modal">Sharing and Access Management</a>
                </li>
                <li>
                  <a tabindex="-1" href="#metadata-modal"
                     id="metadata-link"
                     data-toggle="modal">Metadata</a>
                </li>
              </ul>
            </li>

            <li>
              {% if g.user %}
                <a href="{{ url_for('logout') }}">sign out [{{ g.user.name }}]</a>
              {% else %}
                <a href="{{ url_for('login') }}">sign in</a>
              {% endif %}
            </li>
          </ul>

          <ul class="nav pull-right"> 
            <li>
              <div id="usernamedisplay"></div>
            </li>
	  </ul>
        </div>
      </div>
    </div> 
    {# End page navigation controls #}

    <!-- Content well -->
    <div class="container-fluid">
      <div class="row-fluid">

        <!-- Main content -->
        <div class="span9" id="editorspan">
          {% block editor %}{% endblock %}
        </div>

        <!-- Collection Editor -->   
        <div class="span3" id="collectionspan">
          <div id="workspaces"></div>
        </div>
      </div>
      <footer>
        copyright &copy; 2012 connexions |
        <a href="http://www.dcarter.co.uk"> design by dcarter</a>
      </footer>
    </div> <!-- /.container-fluid -->


  <!-- Modal structures -->
  <div class="modal hide fade in" id="metadata-modal">
    <form name="metadata-form" action="metadata" method="POST">
      <div class="modal-header">
        <button type="button" class="close"
                data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="modal-header-label">Edit Metadata</h3>
      </div>
      <div class="modal-body">
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn" data-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>

  <div class="modal hide fade in" id="import-modal">
    <form name="import-form" action="import" method="POST">
      <div class="modal-header">
        <button type="button" class="close"
                data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="modal-header-label">Import</h3>
      </div>
      <div class="modal-body">
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Import</button>
        <button type="button" class="btn" data-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>

  <div class="modal hide fade in" id="sharing-modal">
    <form name="sharing-form" action="sharing" method="POST">
      <div class="modal-header">
        <button type="button" class="close"
                data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="modal-header-label">Sharing</h3>
      </div>
      <div class="modal-body">

      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn" data-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>

  <div class="modal hide fade in" id="roles-modal">
    <form name="roles-form" action="roles" method="POST">
    <div class="modal-header">
      <button type="button" class="close"
              data-dismiss="modal" aria-hidden="true">×</button>
      <h3 id="modal-header-label">Roles</h3>
    </div>
    <div class="modal-body">

    </div>
    <div class="modal-footer">
      <button type="submit" class="btn btn-primary">Save</button>
      <button type="button" class="btn" data-dismiss="modal">Cancel</button>
    </div>
    </form>
  </div>

  <div class="modal hide fade in" id="publish-modal">
    <form name="publish-form" action="publish" method="POST">
      <div class="modal-header">
        <button type="button" class="close"
                data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="modal-header-label">Publish</h3>
      </div>
      <div class="modal-body">

      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Publish</button>
        <button type="button" class="btn" data-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
  {% endblock %}
</body>
</html>
