
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Logging with Frozone &mdash; rhaptos2 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="rhaptos2 0.0.1 documentation" href="../index.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../_static/small_flask.css" type= "text/css" rel="stylesheet" />

  </head>
  <body>
  
  

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../index.html">rhaptos2 0.0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="logging-with-frozone">
<h1>Logging with Frozone<a class="headerlink" href="#logging-with-frozone" title="Permalink to this headline">¶</a></h1>
<p>When we talk about logging we essentially mean three different
things</p>
<ol class="arabic simple">
<li>metric gathering</li>
<li>auditing (passive monitoring)</li>
<li>pokeing (active monitoring)</li>
</ol>
<p>Auditing is what we usually think of as logging.  It is usually stored
in text files, telling us what <em>has</em> happened, using <em>messages</em> sent
from the code, when a developer thinks that is a good idea (often
after an exception).</p>
<p>We can append a message to the log file as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">lg</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;the pdf for user </span><span class="si">%s</span><span class="s"> collection </span><span class="si">%s</span><span class="s"> failed on server </span><span class="si">%s</span><span class="se">\</span>
<span class="s">with err </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We shall use the standard <em>syslog</em> for this, but forward all collection
of logs to a central syslog server.</p>
<p>Metric gathering is really about graphing and seeing what is going
right / wrong over time.</p>
<p>We can do this as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">statsd</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">statsd</span><span class="o">.</span><span class="n">StatsClient</span><span class="p">(</span><span class="n">STATSD_HOST</span><span class="p">,</span> <span class="n">STATSD_PORT</span><span class="p">)</span>
<span class="c">#...</span>
<span class="n">c</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s">&#39;frozone.statsd.test&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Pokeing, my term is derived from this <a class="reference external" href="https://plus.google.com/112678702228711889851/posts/eVeouesvaVX">Steve Yegge</a>
post.  There is a spectrum between testing a web-service, seeing if it
returns 4 when asked 2+2, and determinng if it is up, responding under
load, and so on.  We will develop monitoring of a web service, that will
be indistuinguishable from QA testing of that service.</p>
<div class="section" id="graphite-statsd">
<h2>Graphite / Statsd<a class="headerlink" href="#graphite-statsd" title="Permalink to this headline">¶</a></h2>
<div class="section" id="summary">
<h3>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>make lxc-destroy host=hpcube fabfile=deploy/fab_lxc.py vhostname=devlog vhostip=10.0.0.22
make newcontainer host=hpcube fabfile=deploy/fab_lxc.py vhostname=devlog vhostip=10.0.0.22
ping devlog ...
make graphite host=devlog fabfile=deploy/fab_sys_graphite.py</pre>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This is not fully automated install, and is unlikely to be due
to nature of config changes=, and that it is part of
infrastructure so automation monkey sits on sysadmin not
devops.</p>
</div>
<p>It seems that the popularity of this approach came from a <a class="reference external" href="http://codeascraft.etsy.com/2011/02/15/measure-anything-measure-everything/">blog
post</a>,
which might explain a lot.</p>
<p>Anyway, the architecture is relatively simple.</p>
<ul class="simple">
<li>Your code uses statsd library, which opens a UDP socket to the
statsd server</li>
<li>the statsd server is a node.js server, that listens for ten
seconds, gathers each &#8216;foo.bar&#8217; message, and averages them over
10 seconds and passes it to the graphite server</li>
<li>the graphite server, which can be seen as a single whole when
frankly it is not, creates a new metric</li>
</ul>
<p>Carbon is the database (rrd-alike), graphite is the
web-server-display and whisper is the listening server feeding
carbon.  I think.</p>
<p>advantages of the approach</p>
<ol class="arabic simple">
<li>You can create any metric on the fly. foo.bar.wibble.ct is
meaningful.</li>
<li>its network-aware, simple and pretty bullet proof.</li>
</ol>
</div>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<div class="figure">
<a class="reference internal image-reference" href="installation/graphite_web.png"><img alt="installation/graphite_web.png" src="installation/graphite_web.png" /></a>
</div>
<p>Todo</p>
<ul class="simple">
<li>run statsd under supervisord</li>
<li>some basic internal</li>
</ul>
</div>
<div class="section" id="install">
<h3>Install<a class="headerlink" href="#install" title="Permalink to this headline">¶</a></h3>
<p>I am recommending building graphite / statsd entirely on a virtual
server.  There are a large number of dependancies and
configuration issues, and when the whole service is conceptually
&#8216;just a box over there&#8217;, you may as well make it a box over there
and not worry.</p>
<p>So, create a lxc container as discussed elsewhere, and the set up the sys level server using :</p>
</div>
<div class="section" id="biblio">
<h3>biblio<a class="headerlink" href="#biblio" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://www.facebook.com/note.php?note_id=32008268919">http://www.facebook.com/note.php?note_id=32008268919</a>
<a class="reference external" href="http://geek.michaelgrace.org/2011/09/how-to-install-graphite-on-ubuntu/">http://geek.michaelgrace.org/2011/09/how-to-install-graphite-on-ubuntu/</a></p>
<p>no change to wsgiimportscript</p>
<div class="highlight-python"><pre>root@cnx4:~# tcpdump -tnX port 8125
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes
IP 10.0.0.102.17723 &gt; 10.0.0.14.8125: UDP, length 23
0x0000:  4500 0033 918a 0000 4011 d4bc 0a00 0066  E..3....@......f
0x0010:  0a00 000e 453b 1fbd 001f f6ce 6672 6f7a  ....E;......froz
0x0020:  6f6e 652e 7374 6174 7364 2e74 6573 743a  one.statsd.test:
0x0030:  317c 63                                  1|c</pre>
</div>
</div>
</div>
<div class="section" id="logging-audit-style">
<h2>Logging - audit style<a class="headerlink" href="#logging-audit-style" title="Permalink to this headline">¶</a></h2>
<p>Using syslog - or rather the Ubuntu version rsyslogd.</p>
<p>rsyslogd still seems to have a few bugs to be ironed out in ubuntu,
but it has been well tested in the Debian world, and is simplest
solution we have for now.</p>
<p>The setup - we shall have <em>one</em> remote server, the logging server,
that will collate all logs sent by the other servers.  All client
servers will log to their local drives and forward on over tcp to the
remote logging server.</p>
<p>rsyslog is installed and enabled by deafualt in Ubuntu since (?).  We
will want to change the default listening port from 514 to 5514 (bug:
following a drop in privileses from startup user to syslog:syslog,
ports below 1024 seem inaccessible)</p>
<p>The clients obviously need to be told to log in that direction.</p>
<p>We also want to turn off the default beahviour of writing some errors
to the xconsole, as we have non X machines.</p>
<p>We also want to configure the Python scripts to use local syslog
socket (&#8216;/dev/log&#8217;)</p>
<p>Server:</p>
<div class="highlight-python"><pre>/etc/rsyslog.conf

# provides TCP syslog reception
$ModLoad imtcp
$InputTCPServerRun 5514

uncomment the above two lines - we now listen for TCP connections</pre>
</div>
<p>now:</p>
<div class="highlight-python"><pre>sudo service rsyslog restart</pre>
</div>
<p>src machine:</p>
<div class="highlight-python"><pre>&lt;/etc/rsyslog.conf&gt;
#attempt to forward allloggingto cnx4
*.* @@cnx4.office.mikadosoftware.com:5514</pre>
</div>
<p>note the double &#64; symbol - means send by TCP</p>
<p>Turn off silly xlogging - this is a known issue in Ubunutu:</p>
<div class="highlight-python"><pre>/etc/rsyslog.d/50-default.conf

  We need to comment out the below in
  /etc/rsyslog.d/50-default.conf
  (https://bugs.launchpad.net/ubuntu/+source/rsyslog/+bug/459730)


  #daemon.*;mail.*;\
  # news.err;\
  # *.=debug;*.=info;\
  # *.=notice;*.=warn |/dev/xconsole

  thus stopping rsyslog trying to log to a X server console on a X-less box.</pre>
</div>
<div class="highlight-python"><pre>Path to syslog config file:
/etc/rsyslog.conf

Syslog PID file
/var/run/rsyslogd.pid

Path to syslog server
/usr/sbin/rsyslogd

Command to start syslog
service rsyslog start

Command to apply changes
service rsyslog reload

Command to re-open log files
service rsyslog restart</pre>
</div>
</div>
<div class="section" id="logging-in-python">
<h2>Logging in Python<a class="headerlink" href="#logging-in-python" title="Permalink to this headline">¶</a></h2>
<p>We are needing to look at various different module hierarchies.
I am assuming the following</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/local/bin/python</span>
<span class="c">#! -*- coding: utf-8 -*-</span>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">&#39;&#39;&#39;</span>


<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">logging.handlers</span> <span class="kn">import</span> <span class="n">SysLogHandler</span>
<span class="kn">from</span> <span class="nn">frozone</span> <span class="kn">import</span> <span class="n">conf</span>

<span class="c">#needs a test if syslog is actually up...</span>

<span class="k">def</span> <span class="nf">getFrozoneLogger</span><span class="p">(</span><span class="n">modname</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;simple, pre-configured logger will be returned.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">lg</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
    <span class="n">lg</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">LOGLEVEL</span><span class="p">)</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">SysLogHandler</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">SYSLOG_SOCK</span><span class="p">)</span>
    <span class="n">lg</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lg</span>

    <span class="kn">import</span> <span class="nn">logging</span>
    <span class="n">lg</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="where-do-we-find-the-grpahite-database">
<h3>Where do we find the grpahite database?<a class="headerlink" href="#where-do-we-find-the-grpahite-database" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>/opt/graphite/storage</li>
</ul>
<div class="highlight-python"><pre>$ sqlite3 graphite.db
&gt;&gt; select * from sqlite_master;

.help

 sqlite&gt; .databases
 seq  name             file
 ---  ---------------  ----------------------------------------------------------
 0    main             /opt/graphite/storage/graphite.db

 sqlite&gt; .tables
 account_mygraph             auth_user_groups
 account_profile             auth_user_user_permissions
 account_variable            dashboard_dashboard
 account_view                dashboard_dashboard_owners
 account_window              django_admin_log
 auth_group                  django_content_type
 auth_group_permissions      django_session
 auth_message                events_event
 auth_permission             tagging_tag
 auth_user                   tagging_taggeditem


 &gt; select * from auth_user;
 1|root|||paul@mikadosoftware.com| ....
 THis is what I created at fabfile time</pre>
</div>
<div class="section" id="getting-to-the-data-on-disk">
<h4>Getting to the data on disk<a class="headerlink" href="#getting-to-the-data-on-disk" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">whisper</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">whisper</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;/opt/graphite/storage/whisper/rhaptos2/carbon/verify.wsp&#39;</span><span class="p">)</span>
<span class="go">{&#39;maxRetention&#39;: 157784400, &#39;xFilesFactor&#39;: 0.5, &#39;aggregationMethod&#39;: &#39;average&#39;, &#39;archives&#39;: [{&#39;retention&#39;: 21600, &#39;secondsPerPoint&#39;: 10, &#39;points&#39;: 2160, &#39;size&#39;: 25920, &#39;offset&#39;: 52}, {&#39;retention&#39;: 604800, &#39;secondsPerPoint&#39;: 60, &#39;points&#39;: 10080, &#39;size&#39;: 120960, &#39;offset&#39;: 25972}, {&#39;retention&#39;: 157784400, &#39;secondsPerPoint&#39;: 600, &#39;points&#39;: 262974, &#39;size&#39;: 3155688, &#39;offset&#39;: 146932}]}</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h4>biblio:<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://www.aosabook.org/en/graphite.html">http://www.aosabook.org/en/graphite.html</a>
<a class="reference external" href="http://graphite.readthedocs.org/en/0.9.10/index.html">http://graphite.readthedocs.org/en/0.9.10/index.html</a>
<a class="reference external" href="http://stackoverflow.com/questions/7099197/tracking-metrics-using-statsd-via-etsy-and-graphite-graphite-graph-doesnt-se">http://stackoverflow.com/questions/7099197/tracking-metrics-using-statsd-via-etsy-and-graphite-graphite-graph-doesnt-se</a></p>
</div>
<div class="section" id="issues-to-note">
<h4>Issues to note<a class="headerlink" href="#issues-to-note" title="Permalink to this headline">¶</a></h4>
<p>Logger instances <em>hang around</em> - they are designed as singleton
servers, so creating them a lot really can hurt. One logger per
running module is a good balance of granualrity and manageability.</p>
<p>Logging usernames etc is important, and we shall developer either a
LoggerAdapter approach or just keep it in parameters passed, depending
on how the app evolves.  Watch this space.</p>
<p>graphite:</p>
<p>Do not publish updates faster than the minimum interval in
your storage-schemas.conf file.</p>
<p>This means that the statsd aggregator and the storage-schemas.conf
<em>must</em> be in sync else if carbon aggreagtes every minute, but statsd
pushes every 10 secs you will have statsd overwrite its own records
5/6 of the time</p>
<p>Note that this will not mean we can carry forward absolute metrics - we get averages
over the minumum sampling time.  This can be a problem if our traffic is bursty.
As either statsd or carcbon will eventually average out our bursty ness.</p>
<p>To Do:</p>
<p>There is a lot to do here - setting timespans of logging
granualrity. using and setting up the graphite as a stort of
dashboard.</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/rhaptos2userlogo.jpg" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Logging with Frozone</a><ul>
<li><a class="reference internal" href="#graphite-statsd">Graphite / Statsd</a><ul>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#example">Example</a></li>
<li><a class="reference internal" href="#install">Install</a></li>
<li><a class="reference internal" href="#biblio">biblio</a></li>
</ul>
</li>
<li><a class="reference internal" href="#logging-audit-style">Logging - audit style</a></li>
<li><a class="reference internal" href="#logging-in-python">Logging in Python</a><ul>
<li><a class="reference internal" href="#where-do-we-find-the-grpahite-database">Where do we find the grpahite database?</a><ul>
<li><a class="reference internal" href="#getting-to-the-data-on-disk">Getting to the data on disk</a></li>
<li><a class="reference internal" href="#id1">biblio:</a></li>
<li><a class="reference internal" href="#issues-to-note">Issues to note</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/installation/logging.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    &copy; Copyright 2012, Paul Brian.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  
  </body>
</html>